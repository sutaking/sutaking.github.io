---
layout: post
title: ES6ä¸­çš„å¼‚æ­¥ç¼–ç¨‹ï¼šGeneratorså‡½æ•°+Promise:æœ€å¼ºå¤§çš„å¼‚æ­¥å¤„ç†æ–¹å¼
date: 2016-11-16 16:00:24.000000000 +08:00
---

[è®¿é—®åŸæ–‡åœ°å€](http://njfeng.com/2016/11/generation-async/)

generatorsä¸»è¦ä½œç”¨å°±æ˜¯æä¾›äº†ä¸€ç§ï¼Œå•çº¿ç¨‹çš„ï¼Œå¾ˆåƒåŒæ­¥æ–¹æ³•çš„ç¼–ç¨‹é£æ ¼ï¼Œæ–¹ä¾¿ä½ æŠŠå¼‚æ­¥å®ç°çš„é‚£äº›ç»†èŠ‚è—åœ¨åˆ«å¤„ã€‚è¿™è®©æˆ‘ä»¬å¯ä»¥ç”¨ä¸€ç§å¾ˆè‡ªç„¶çš„æ–¹å¼ä¹¦å†™æˆ‘ä»¬ä»£ç ä¸­çš„æµç¨‹å’ŒçŠ¶æ€é€»è¾‘ï¼Œä¸å†éœ€è¦å»éµå¾ªé‚£äº›å¥‡æ€ªçš„å¼‚æ­¥ç¼–ç¨‹é£æ ¼ã€‚

æ¢å¥è¯è¯´ï¼Œé€šè¿‡å°†æˆ‘ä»¬generatoré€»è¾‘ä¸­çš„ä¸€äº›å€¼çš„è¿ç®—æ“ä½œå’Œå’Œå¼‚æ­¥å¤„ç†(ä½¿ç”¨generatorsçš„è¿­ä»£å™¨iterator)è¿™äº›å€¼å®ç°ç»†èŠ‚åˆ†å¼€æ¥å†™ï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸å¥½çš„æŠŠæ€§èƒ½å¤„ç†å’Œä¸šåŠ¡å…³æ³¨ç‚¹ç»™åˆ†å¼€ã€‚

ç»“æœå‘¢ï¼Ÿæ‰€æœ‰é‚£äº›å¼ºå¤§çš„å¼‚æ­¥ä»£ç ï¼Œå°†å…·å¤‡è·ŸåŒæ­¥ç¼–ç¨‹ä¸€æ ·çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚

é‚£ä¹ˆæˆ‘ä»¬å°†å¦‚ä½•å®Œæˆè¿™äº›å£®ä¸¾ï¼Ÿ

## ä¸€ä¸ªç®€å•çš„å¼‚æ­¥åŠŸèƒ½

å…ˆä»è¿™ä¸ªéå¸¸çš„ç®€å•çš„sampleä»£ç å¼€å§‹ï¼Œç›®å‰generatorså¹¶ä¸éœ€è¦å»é¢å¤–çš„å¤„ç†ä¸€äº›è¿™æ®µä»£ç è¿˜æ²¡æœ‰äº†çš„å¼‚æ­¥åŠŸèƒ½ã€‚

ä¸¾ä¾‹ä¸‹ï¼ŒåŠ å…¥ç°åœ¨çš„å¼‚æ­¥ä»£ç å·²ç»æ˜¯è¿™æ ·çš„äº†ï¼š

```javascript
function makeAjaxCall(url, cb) {
	//do some ajax fun
	//call cb(result) when complete
}

makeAjaxCall('http://some.url.1', function(result1) {
	var data = JSON.parse(result1);
	
	makeAjaxCall('http://some.url.2/?id='+data.id, function(result2) {
		var resp = JSON.parse(result2);
		console.log('The value you asked for: '+ resp.value);
	});
});
```

ç”¨ä¸€ä¸ªgeneratorï¼ˆä¸æ·»åŠ ä»»ä½•decorationï¼‰å»é‡æ–°å®ç°ä¸€éï¼Œä»£ç çœ‹è¿™é‡Œï¼š

```javascript
function request(url) {
	// this is where we're hiding the asynchronicity,
	// away from the main code of our generator
	// it.next() æ˜¯generatorsçš„è¿­ä»£å™¨
	makeAjaxCall(url, function(response) {
		it.next(response);
	});
}

function *main() {
	var result1 = yield request('http://some.url.1');
	var data = JSON.parse(result1);
	
	var result2 = yield request('http://some.url.2/?id='+data.id);
	var resp = JSON.parse(result2);
	console.log('The value you asked for: '+ resp.value);
}

var it = main();
it.next(); //å¯åŠ¨æ‰€æœ‰è¯·æ±‚
```

è®©æˆ‘ä»¬æ‹ä¸€ä¸‹è¿™æ˜¯å¦‚ä½•å·¥ä½œçš„

`request(..)`å‡½æ•°å¯¹`makeAjaxCall(..)`åšäº†åŸºæœ¬å°è£…ï¼Œè®©æ•°æ®è¯·æ±‚çš„å›è°ƒå‡½æ•°ä¸­è°ƒç”¨generatorçš„iteratorçš„`next(...)`æ–¹æ³•ã€‚

å…ˆæ¥çœ‹è°ƒç”¨`request("..")`ï¼Œä½ ä¼šå‘ç°è¿™é‡Œæ ¹æœ¬æ²¡æœ‰returnä»»ä½•å€¼ï¼ˆæ¢å¥è¯æ¥è¯´ï¼Œè¿™æ˜¯undefinedï¼‰ã€‚è¿™æ²¡å…³ç³»ï¼Œä½†æ˜¯å®ƒè·Ÿæˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« åé¢ä¼šè®¨è®ºåˆ°çš„æ–¹æ³•åšå¯¹æ¯”æ˜¯å¾ˆé‡è¦çš„ï¼šæˆ‘éœ€è¦æœ‰æ•ˆçš„åœ¨è¿™é‡Œä½¿ç”¨yield undefined.

è¿™æ—¶æˆ‘ä»¬æ¥è°ƒç”¨yieldï¼ˆè¿™æ—¶è¿˜æ˜¯ä¸€ä¸ªundefinedå€¼ï¼‰ï¼Œå…¶å®é™¤äº†æš‚åœä¸€ä¸‹æˆ‘ä»¬çš„generatorsä¹‹å¤–æ²¡æœ‰åšåˆ«çš„äº†ã€‚å®ƒå°†ç­‰å¾…çŸ¥é“ä¸‹æ¬¡å†è°ƒç”¨it.next(..) æ‰æ¢å¤ï¼Œæˆ‘ä»¬é˜Ÿåˆ—å·²ç»æŠŠå®ƒåœ¨å®‰æ’åœ¨ï¼ˆä½œä¸ºä¸€ä¸ªå›è°ƒï¼‰Ajaxè¯·æ±‚ç»“æŸçš„æ—¶å€™ã€‚

ä½†æ˜¯å½“yieldè¡¨è¾¾å¼æ‰§è¡Œè¿”å›ç»“æœåæˆ‘ä»¬åšäº†ä»€ä¹ˆï¼Ÿæˆ‘ä»¬æŠŠè¿”å›å€¼èµ‹å€¼ç»™äº†result1.ã€‚é‚£ä¸ºä»€ä¹ˆyieldä¼šæœ‰ä»ç¬¬ä¸€ä¸ªAjaxè¯·æ±‚è¿”å›çš„å€¼ï¼Ÿ

è¿™æ˜¯å› ä¸ºå½“it.next(..)åœ¨Ajaxçš„callbackä¸­è°ƒç”¨çš„æ˜¯å¶ï¼Œå®ƒä¼ é€’Ajaxçš„è¿”å›ç»“æœã€‚è¿™è¯´æ˜è¿™ä¸ªè¿”å›å€¼å‘é€åˆ°æˆ‘ä»¬çš„generatorsæ—¶ï¼Œå·²ç»ä¸­é—´é‚£å¥`result1 = yield .. `ç»™æš‚åœä¸‹æ¥äº†ã€‚

è¿™ä¸ªçœŸçš„å¾ˆé…·å¾ˆå¼ºå¤§ã€‚å®è´¨ä¸Šçœ‹ï¼Œ`result1 = yield request(..)`è¿™å¥æ˜¯è¯·æ±‚æ•°æ®ï¼Œä½†æ˜¯å®ƒå®Œå…¨æŠŠå¼‚æ­¥é€»è¾‘åœ¨æˆ‘ä»¬é¢å‰è—èµ·æ¥äº†ï¼Œè‡³å°‘ä¸éœ€è¦æˆ‘ä»¬åœ¨è¿™é‡Œè€ƒè™‘è¿™éƒ¨åˆ†å¼‚æ­¥é€»è¾‘ï¼Œå®ƒé€šè¿‡yieldçš„æš‚åœèƒ½åŠ›éšè—äº†å¼‚æ­¥é€»è¾‘ï¼ŒåŒæ—¶æŠŠgeneratoræ¢å¤é€»è¾‘çš„åŠŸèƒ½åˆ†ç¦»åˆ°ä¸‹ä¸€ä¸ªyieldå‡½æ•°ä¸­ã€‚è¿™å°±è®©æˆ‘ä»¬çš„ä¸»è¦é€»è¾‘çœ‹ä¸Šå»å¾ˆåƒä¸€ä¸ªåŒæ­¥è¯·æ±‚æ–¹æ³•ã€‚

ç¬¬äºŒå¥è¡¨è¾¾å¼`result2 = yield result(..)`ä¹ŸåŸºæœ¬ä¸€æ ·çš„ä½œç”¨ï¼Œå®ƒå°†pausesä¸resumesä¼ è¿›å»ï¼Œè¾“å‡ºä¸€ä¸ªæˆ‘ä»¬è¯·æ±‚çš„å€¼ï¼Œä¹Ÿæ ¹æœ¬ä¸éœ€è¦å¯¹å¼‚æ­¥æ“ä½œæ‹…å¿ƒã€‚

å½“ç„¶ï¼Œå› ä¸ºyieldçš„å­˜åœ¨ï¼Œè¿™é‡Œä¼šæœ‰ä¸€ä¸ªå¾®å¦™çš„æç¤ºï¼Œåœ¨è¿™ä¸ªç‚¹ä¸Šä¼šå‘ç”Ÿä¸€äº›ç¥å¥‡çš„äº‹æƒ…ï¼ˆä¹Ÿç§°å¼‚æ­¥ï¼‰ã€‚ä½†æ˜¯è·Ÿå™©æ¢¦èˆ¬çš„åµŒå¥—å›è°ƒåœ°ç‹±ï¼ˆæˆ–è€…æ˜¯promiseé“¾çš„APIå¼€é”€ï¼‰ç›¸æ¯”ï¼Œyieldè¯­å¥åªæ˜¯éœ€è¦ä¸€ä¸ªå¾ˆå°çš„è¯­æ³•å¼€é”€/æç¤ºã€‚

ä¸Šé¢çš„ä»£ç æ€»æ˜¯å¯åŠ¨ä¸€ä¸ªå¼‚æ­¥Ajaxè¯·æ±‚ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰åšä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿå¦‚æœæˆ‘ä»¬åæ¥æ›´æ”¹äº†æˆ‘ä»¬ç¨‹åºä¸­å…ˆå‰ï¼ˆé¢„å…ˆè¯·æ±‚ï¼‰çš„Ajaxè¿”å›çš„æ•°æ®ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿæˆ–è€…æˆ‘ä»¬çš„ç¨‹åºçš„URLè·¯ç”±ç³»ç»Ÿé€šè¿‡å…¶ä»–ä¸€äº›å¤æ‚çš„é€»è¾‘ï¼Œå¯ä»¥ç«‹å³æ»¡è¶³Ajaxè¯·æ±‚ï¼Œè¿™æ—¶å°±å¯ä»¥ä¸éœ€è¦fetchæ•°æ®ä»æœåŠ¡å™¨äº†ã€‚

We could change the implementation of request(..) to something like this:
è¿™æ ·ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ`request(..)`ä»£ç ç¨å¾®ä¿®æ”¹ä¸€ä¸‹

```javascript
var cache = {};

function request(url) {
	if(cache[url]) {
		// defer cacheé‡Œé¢çš„æ•°æ®å¯¹ç°åœ¨æ¥è¯´æ˜¯å·²ç»è¶³å¤Ÿäº†
		// æ‰§è¡Œä¸‹é¢
		setTimeout(function() {
			it.next(cache[url])
		}, 0);
	}
	else {
		makeAjaxCall(url, function(resp) {
			cache[url] = resp;
			it.next(resp);
		})
	}
}
```

æ³¨æ„ï¼šä¸€å¥å¾ˆå¥‡å¦™ã€ç¥å¥‡çš„`setTimeout(..0)`æ”¾åœ¨äº†å½“ç¼“å­˜ä¸­å·²ç»è¯·æ±‚è¿‡æ•°æ®çš„å¤„ç†é€»è¾‘ä¸­ã€‚å¦‚æœæˆ‘ä»¬ç«‹å³è°ƒç”¨`it.next(...)`ï¼Œè¿™æ ·ä¼šå‘ç”Ÿä¸€ä¸ªerrorï¼Œè¿™æ˜¯å› ä¸ºgeneratorè¿˜æ²¡æœ‰å®Œæˆpausedæ“ä½œã€‚æˆ‘ä»¬çš„å‡½æ•°é¦–å…ˆè¦å®Œå…¨è°ƒç”¨`request(..)`,è¿™æ—¶æ‰ä¼šå¯åŠ¨yieldçš„æš‚åœã€‚å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ç«‹å³åœ¨`request(..)`ä¸­ç«‹å³è°ƒç”¨`it.next(...)`ï¼Œè¿™æ˜¯å› ä¸ºè¿™æ—¶generatorä»ç„¶åœ¨è¿è¡Œ(yieldå¹¶æ²¡æœ‰æ‰§è¡Œ)ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç¨åä¸€ç‚¹è°ƒç”¨`it.next(...)`ï¼Œç­‰å¾…ç°åœ¨çš„çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å°±æ˜¯`setTimeout(..0)`è¿™å¥æœ‰é­”æ€§çš„ä»£ç æ”¾åœ¨è¿™é‡Œçš„æ„ä¹‰ã€‚æˆ‘ä»¬ç¨åè¿˜ä¼šæœ‰ä¸€ä¸ªæ›´å¥½çš„è§£å†³åŠæ³•ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬çš„generatorä»£ç å¹¶ä¸éœ€è¦å‘ç”Ÿä»»ä½•å˜åŒ–ï¼š

```javascript
var restult1 = yield request('http://some.url.1');
var data = JSON.parse(result1);
...
```

çœ‹åˆ°æ²¡ï¼Ÿæˆ‘ä»¬çš„generatoré€»è¾‘ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æµç¨‹é€»è¾‘ï¼‰å³ä½¿å¢åŠ äº†ç¼“å­˜å¤„ç†åŠŸèƒ½åï¼Œä»ä¸éœ€è¦å‘ç”Ÿä»»ä½•æ”¹å˜ã€‚

`*main()`ä¸­çš„ä»£ç è¿˜æ˜¯åªéœ€è¦è¯·æ±‚æ•°æ®åæš‚åœï¼Œä¹‹åç­‰åˆ°æ•°æ®è¿”å›åé¡ºåºæ‰§è¡Œä¸‹å»ã€‚åœ¨æˆ‘ä»¬å½“å‰çš„æƒ…å†µä¸‹ï¼Œâ€˜æš‚åœâ€™å¯èƒ½ç›¸å¯¹è¦é•¿ä¸€äº›ï¼ˆåšä¸€ä¸ªæœåŠ¡å™¨çš„è¯·æ±‚ï¼Œå¤§çº¦è¦300~800msï¼‰ï¼Œæˆ–è€…ä»–å¯ä»¥å‡ ä¹ç«‹å³è¿”å›ï¼ˆèµ°setTimeoutçš„é€»è¾‘ï¼‰ï¼Œä½†æ˜¯æˆ‘ä»¬çš„æµç¨‹é€»è¾‘å®Œå…¨ä¸éœ€è¦å…³å¿ƒè¿™äº›ã€‚

è¿™å°±æ˜¯å°†å¼‚æ­¥ç¼–ç¨‹æŠ½è±¡æˆæ›´å°ç»†èŠ‚çš„çœŸæ­£åŠ›é‡ã€‚

æ›´å¥½çš„å¼‚æ­¥ç¼–ç¨‹

ä¸Šé¢çš„æ–¹æ³•å¯ä»¥é€‚ç”¨äºé‚£äº›æ¯”è¾ƒç®€å•çš„å¼‚æ­¥generatorå·¥ä½œæµç¨‹ã€‚ä½†æ˜¯å®ƒå°†å¾ˆå¿«æ”¶åˆ°é™åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€äº›æ›´å¼ºå¤§çš„å¼‚æ­¥æœºåˆ¶ä¸æˆ‘ä»¬çš„generatoræ¥åˆä½œï¼Œè¿™æ ·æ‰å¯ä»¥å‘æŒ¥å‡ºæ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚é‚£æ˜¯ä»€ä¹ˆæœºåˆ¶ï¼šPromiseã€‚

æ—©å…ˆçš„Ajaxå®ä¾‹æ€»æ˜¯ä¼šæ”¶åˆ°åµŒå¥—å›è°ƒçš„å›°æ‰°ï¼Œé—®é¢˜å¦‚ä¸‹ï¼š

-	1.æ²¡æœ‰æ˜ç¡®çš„æ–¹æ³•æ¥å¤„ç†è¯·æ±‚errorã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒAjaxè¯·æ±‚æœ‰æ—¶æ˜¯ä¼šå¤±è´¥çš„ï¼Œè¿™æ—¶æˆ‘ä»¬éœ€è¦ä½¿ç”¨generatorä¸­çš„`it.throw(...)`,åŒæ—¶è¿˜éœ€è¦ä½¿ç”¨`try...catch`æ¥å¤„ç†è¯·æ±‚é”™è¯¯æ—¶çš„é€»è¾‘ã€‚ä½†æ˜¯è¿™æ›´å¤šæ˜¯ä¸€äº›åœ¨åå°ï¼ˆæˆ‘ä»¬é‚£äº›åœ¨iteratorä¸­çš„ä»£ç ï¼‰æ‰‹åŠ¨çš„å·¥ä½œã€‚æˆ‘éœ€è¦ä¸€äº›å¯ä»¥æœç”¨çš„æ–¹æ³•ï¼Œæ”¾åœ¨æˆ‘ä»¬è‡ªå·±ä»£ç çš„generatorä¸­ã€‚

-	2.å‡å¦‚`makeAjaxCall(..)`è¿™æ®µä»£ç ä¸åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¸‹äº†ï¼Œæˆ–è€…ä»–éœ€è¦å¤šæ¬¡è°ƒç”¨å›è°ƒï¼Œåˆæˆ–è€…å®ƒåŒæ—¶è¿”å›successä¸errorï¼Œç­‰ç­‰ã€‚è¿™æ—¶æˆ‘ä»¬çš„generatorçš„ä¼šå˜å¾—ä¹±ä¸ƒå…«ç³Ÿï¼ˆè¿”å›errorå®ç°ï¼Œå‡ºç°å¼‚å¸¸å€¼ï¼Œç­‰ç­‰ï¼‰ã€‚æ§åˆ¶ä»¥åŠé˜²æ­¢å‘ç”Ÿè¿™ç±»é—®é¢˜æ˜¯éœ€è¦èŠ±è´¹å¤§é‡çš„æ‰‹å·¥æ—¶é—´çš„ï¼Œè€Œä¸”ä¸€ç‚¹ä¹Ÿä¸èƒ½å³æ’å³ç”¨ã€‚

-	3.é€šå¸¸æˆ‘éœ€è¦æ‰§è¡Œå¹¶è¡Œæ‰§è¡Œä»»åŠ¡ï¼ˆæ¯”å¦‚åŒæ—¶åš2ä¸ªAjaxè¯·æ±‚ï¼‰ã€‚ç”±äºgenerator yieldæœºåˆ¶éƒ½æ˜¯é€æ­¥æš‚åœï¼Œæ— æ³•åœ¨åŒæ—¶è¿è¡Œå¦ä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ï¼Œä»–çš„ä»»åŠ¡å¿…é¡»ä¸€ä¸ªä¸€ä¸ªçš„æŒ‰é¡ºåºæ‰§è¡Œã€‚å› æ­¤ï¼Œè¿™ä¸æ˜¯å¤ªå®¹æ˜“åœ¨ä¸€ä¸ªgeneratorä¸­å»æ“ä½œå¤šä»»åŠ¡ï¼Œæˆ‘ä»¬åªèƒ½é»˜é»˜çš„åœ¨èƒŒåæ‰‹æ’¸å¤§é‡çš„ä»£ç ã€‚

å°±åƒä½ çœ‹åˆ°çš„ï¼Œæ‰€æœ‰çš„é—®é¢˜éƒ½è¢«è§£å†³äº†ã€‚ä½†æ˜¯æ²¡äººæ„¿æ„æ¯æ¬¡éƒ½å»åå¤çš„å»å®ç°ä¸€éè¿™äº›æ–¹æ³•ã€‚æˆ‘ä»¬éœ€è¦ä¸€ç§æ›´å¼ºå¤§çš„æ¨¡å¼ï¼Œä¸“é—¨è®¾è®¡å‡ºä¸€ä¸ªå¯ä¿¡èµ–çš„ï¼Œå¯é‡ç”¨çš„åŸºäºgeneratorå¼‚æ­¥ç¼–ç¨‹çš„è§£å†³æ–¹æ³•ã€‚

ä»€ä¹ˆæ¨¡å¼ï¼ŸæŠŠpromiseä¸yieldç»“åˆï¼Œä½¿å¾—å¯ä»¥åœ¨æ‰§è¡Œå®Œæˆåæ¢å¤generatorçš„æµç¨‹ã€‚

è®©æˆ‘ä»¬ç¨å¾®ç”¨promiseä¿®æ”¹ä¸‹`request(..)`ï¼Œè®©yieldè¿”å›ä¸€ä¸ªpromiseã€‚

```javascript
function request(url) {
	//ç°åœ¨è¿”å›ä¸€ä¸ªpromiseäº†
	return new Promise( function(resolve, reject) {
		makeAjaxCall(url, resolve);
	});
}
```

`request(..)`ç°åœ¨ç”±ä¸€ä¸ªpromiseæ„æˆï¼Œå½“Ajaxè¯·æ±‚å®Œæˆåä¼šè¿”å›è¿™ä¸ªpromiseï¼Œä½†æ˜¯ç„¶åå‘¢ï¼Ÿ

æˆ‘ä»¬éœ€è¦æ§åˆ¶generatorçš„iteratorï¼Œå®ƒå°†æ¥å—åˆ°yieldè¿”å›çš„é‚£ä¸ªpromiseï¼ŒåŒæ—¶é€šè¿‡next(...)æ¢å¤generatorè¿è¡Œï¼Œå¹¶æŠŠä»–ä»¬ä¼ é€’ä¸‹å»ï¼Œæˆ‘å¢åŠ äº†ä¸€ä¸ª`runGenerator(...)`æ–¹æ³•æ¥åšè¿™ä»¶äº‹ã€‚

```javascript
//æ¯”è¾ƒç®€å•ï¼Œæ²¡æœ‰erroräº‹ä»¶å¤„ç†
funtion runGenerator(g) {
	var it = g(), retl
	
	//å¼‚æ­¥iteratoréå†generator
	(function iterate(val) {
		//è¿”å›ä¸€ä¸ªpromise
		ret = it.next(val);
		
		if(!ret.done) {
			if('then' in ret.value) {
				//ç­‰å¾…æ¥æ”¶promise
				ret.value.then(iterate);
			}
			//è·å–ç«‹å³å°±æœ‰çš„æ•°æ®ï¼Œä¸æ˜¯promiseäº†
			else {
				//é¿å…åŒæ­¥æ“ä½œ
				setTimeout(function() {
					iterate(ret.value);
				}, 0);
			}
		}
	})();
}
```

å…³é”®ç‚¹:

-	è‡ªåŠ¨åˆå§‹åŒ–generatorï¼ˆç›´æ¥åˆ›å»ºå®ƒçš„iteratorï¼‰ï¼Œå¹¶ä¸”å¼‚æ­¥é€’å°†ä»–ä¸€ç›´è¿è¡Œåˆ°ç»“æŸï¼ˆå½“`done:true`å°±ä¸åœ¨æ‰§è¡Œï¼‰
-	å¦‚æœPromiseè¢«è¿”å›å‡ºæ¥ï¼Œè¿™æ—¶æˆ‘ä»¬å°±ç­‰å¾…åˆ°æ‰§è¡Œ`then(...)`æ–¹æ³•çš„æ—¶å€™å†å¤„ç†ã€‚
- å¦‚æœæ˜¯å¯ä»¥ç«‹å³è¿”å›çš„æ•°æ®ï¼Œæˆ‘ä»¬ç›´æ¥æŠŠæ•°æ®è¿”å›ç»™generatorè®©ä»–ç›´æ¥å»æ‰§è¡Œä¸‹ä¸€æ­¥ã€‚

```javascript
runGenerator( function *main(){
    var result1 = yield request( "http://some.url.1" );
    var data = JSON.parse( result1 );

    var result2 = yield request( "http://some.url.2?id=" + data.id );
    var resp = JSON.parse( result2 );
    console.log( "The value you asked for: " + resp.value );
} );
```

ç­‰ä¸€ä¸‹ï¼Œç°åœ¨çš„generatorè·ŸåŸå…ˆçš„å®Œå…¨ä¸€æ ·å˜›ã€‚å°½ç®¡æˆ‘ä»¬æ”¹ç”¨äº†promiseï¼Œä½†æ˜¯yieldæ–¹æ³•ä¸éœ€è¦æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œå› ä¸ºæˆ‘ä»¬æŠŠé‚£äº›é€»è¾‘éƒ½ä»æˆ‘ä»¬çš„æµç¨‹ç®¡ç†ä¸­åˆ†ç¦»å‡ºå»äº†ã€‚

å°½ç®¡ç°åœ¨çš„yieldæ˜¯è¿”å›ä¸€ä¸ªpromiseäº†ï¼Œå¹¶æŠŠè¿™ä¸ªpromiseä¼ é€’ç»™ä¸‹ä¸€ä¸ª`it.next(..)`,ä½†æ˜¯`result1 = yield request(..)`è¿™å¥å¾—åˆ°çš„å€¼è·Ÿä»¥å‰è¿˜æ˜¯ä¸€æ ·çš„ã€‚

æˆ‘ä»¬ç°åœ¨å¼€å§‹ç”¨promiseæ¥ç®¡ç†generatorä¸­çš„å¼‚æ­¥ä»£ç ï¼Œè¿™æ ·æˆ‘ä»¬å°±è§£å†³æ‰æ‰€æœ‰ä½¿ç”¨å›è°ƒå‡½æ•°æ–¹æ³•ä¸­ä¼šå‡ºç°çš„åè½¬/ä¿¡ä»»é—®é¢˜ã€‚ç”±äºæˆ‘ä»¬ç”¨äº†generator+promiseçš„æ–¹æ³•ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¢åŠ ä»»ä½•é€»è¾‘å°±è§£å†³æ‰äº†ä»¥ä¸Šæ‰€æœ‰é—®é¢˜

-	æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å¢åŠ ä¸€ä¸ªerrorå¼‚å¸¸å¤„ç†ã€‚è™½ç„¶ä¸åœ¨`runGenerator(...)`ä¸­ï¼Œä½†æ˜¯å¾ˆå®¹æ˜“ä»ä¸€ä¸ªpromiseä¸­ç›‘å¬errorï¼Œå¹¶å®ƒä»–ä»¬çš„é€»è¾‘å†™åœ¨`it.throw(..)`é‡Œé¢ï¼Œè¿™æ—¶æˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸Š`try..catch``æ–¹æ³•åœ¨æˆ‘ä»¬çš„generatorä»£ç ä¸­å»è·å–å’Œç®¡ç†errosäº†ã€‚
- æˆ‘ä»¬å¾—åˆ°åˆ°æ‰€æœ‰çš„ control/trustabilityï¼Œå®Œå…¨ä¸éœ€è¦å¢åŠ ä»£ç ã€‚
-	promiseæœ‰ç€å¾ˆå¼ºçš„æŠ½è±¡æ€§ï¼Œè®©æˆ‘ä»¬å¯ä»¥å®ç°ä¸€äº›å¤šä»»åŠ¡çš„å¹¶è¡Œæ“ä½œã€‚

	æ¯”å¦‚ï¼š`Promise.all([ .. ])`å°±å¯ä»¥å¹¶è¡Œæ‰§è¡Œä¸€ä¸ªpromiseæ•°ç»„ï¼Œyieldè™½ç„¶åªèƒ½æ‹¿åˆ°ä¸€ä¸ªpromiseï¼Œä½†æ˜¯è¿™ä¸ªæ˜¯æ‰€æœ‰å­promiseæ‰§è¡Œå®Œæ¯•ä¹‹åçš„é›†åˆæ•°ç»„ã€‚

å…ˆè®©æˆ‘ä»¬çœ‹ä¸‹errorå¤„ç†çš„ä»£ç ï¼š

```javascript
function request(url) {
	return new Promise( function(resolve, reject) {
		//ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯error
		makeAjaxCall(url, function(err, text) {
			if(err) reject(err);
			else resolve(text);
		});
	});
}

runGenerator(function *main() {
	try {
		var result1 = yield request('http://some.url.1');
	}
	catch(err) {
		console.log('Error:' + err);
		retrun;
	}
	var data = JSON.parse(result1);
	
	try{
		var result2 = yield request('http://some.url.2?id='+data.id);
	}
	catch(err) {
		console.log('Error:' + err);
		retrun;
	}
	var resp = JSON.parse(result2);
	console.log("The value you asked for: " + resp.value);
});

```

å¦‚æœæ‰§è¡Œurlçš„fetchæ—¶promiseè¢«rejectï¼ˆè¯·æ±‚å¤±è´¥ï¼Œæˆ–è€…å¼‚å¸¸ï¼‰äº†ï¼Œpromiseä¼šç»™generatoræŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œé€šè¿‡`try..catch`è¯­å¥å¯ä»¥è·å–åˆ°äº†ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬è®©promiseæ¥å¤„ç†æ›´å¤æ‚çš„å¼‚æ­¥æ“ä½œï¼š

```javascript
function request(url) {
	return new Promise( function(resolve, reject) {
		makeAjax(url, resolve);
	})
	//è·å–åˆ°è¿”å›çš„textå€¼åï¼Œåšä¸€äº›å¤„ç†ã€‚
	.then( function(text) {
		
			//å¦‚æœæˆ‘ä»¬æ‹¿åˆ°çš„æ˜¯ä¸€ä¸ªurlå°±æŠŠtextæå‰å‡ºæ¥åœ¨è¿”å›
			if(/^http?:\/\/.+/.text(text)) {
				return request(text)ï¼›			}
			//å¦‚æœæˆ‘ä»¬å°±æ˜¯è¦ä¸€ä¸ªtextï¼Œç›´æ¥è¿”å›
			else {
				return text;
			}
	});
}

runGenerator (function *main() {
	var search_terms = yield Promise.all([
		request( "http://some.url.1" ),
     request( "http://some.url.2" ),
     request( "http://some.url.3" )
	]);

	var search_results = yield request(
		'http://some.url.4?search='+search_terms.join('+')
	);
	var resp = JSON.parse(search_results);
	
	console.log('Search results:'+resp.value);
});

```

Promise.all([ .. ]) é‡Œé¢æ”¾äº†3ä¸ªå­promiseï¼Œä¸»promiseå®Œæˆåå°±ä¼šåœ¨runGeneratorä¸­æ¢å¤generatorã€‚å­promiseæ‹¿åˆ°çš„æ˜¯ä¸€å¤©é‡å®šå‘çš„urlï¼Œæˆ‘ä»¬ä¼šæŠŠå®ƒä¸¢ç»™ä¸‹ä¸€ä¸ªrequestè¯·æ±‚ï¼Œç„¶åè·å–åˆ°æœ€ç»ˆæ•°æ®ã€‚

ä»»ä½•å¤æ‚çš„å¼‚æ­¥åŠŸèƒ½éƒ½å¯ä»¥è¢«promiseæå®šï¼Œè€Œä¸”ä½ è¿˜å¯ä»¥ç”¨generatoræŠŠè¿™äº›æµç¨‹å†™çš„åƒåŒæ­¥ä»£ç ä¸€æ ·ã€‚åªè¦ä½ è®©yieldè¿”å›ä¸€ä¸ªpromiseã€‚

## ES7 async

ç°åœ¨å¯ä»¥ç¨å¾®æä¸‹ES7äº†ï¼Œå®ƒæ›´åƒæŠŠ`runGenerator(..)`è¿™ä¸ªå¼‚æ­¥æ‰§è¡Œé€»è¾‘åšäº†ä¸€å±‚å°è£…ã€‚

```javascript
async funtion main() {
	var result1 = await request('http://some.url.1');
	var data = JSON.parse(result1);
	
	var result2 = await request('http://some.url.2?id='+data.id);
	var resp = JSON.parse(result2);
	console.log( "The value you asked for: " + resp.value );
}

main();
```

æˆ‘ä»¬ç›´æ¥è°ƒç”¨`main()`å°±å¯ä»¥æ‰§è¡Œå®Œæ‰€æœ‰çš„æµç¨‹ï¼Œä¸éœ€è¦è°ƒç”¨`next`,ä¹Ÿä¸éœ€è¦å»å®ç°`runGenerator(..)`ä¹‹ç±»çš„æ¥ç®¡ç†promiseé€»è¾‘ã€‚åªéœ€è¦æŠŠyieldå…³é”®è¯æ¢æˆawaitå°±å¯ä»¥å‘Šè¯‰å¼‚æ­¥æ–¹æ³•ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œéœ€è¦ç­‰åˆ°ä¸€ä¸ªpromiseåæ‰ä¼šæ¥ç€æ‰§è¡Œã€‚

æœ‰äº†è¿™äº›åŸç”Ÿçš„è¯­æ³•æ”¯æŒï¼Œæ˜¯ä¸æ˜¯å¾ˆé…·ã€‚

## å°ç»“

`generator + yielded promise(s)`çš„ç»„åˆç›®å‰æ˜¯æœ€å¼ºå¤§ï¼Œä¹Ÿæ˜¯æœ€ä¼˜é›…çš„å¼‚æ­¥æµç¨‹ç®¡ç†ç¼–ç¨‹æ–¹å¼ã€‚é€šè¿‡å°è£…ä¸€å±‚æµæ‰§è¡Œé€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªåŠ¨çš„è®©æˆ‘ä»¬çš„generatoræ‰§è¡Œç»“æŸï¼Œå¹¶ä¸”è¿˜å¯ä»¥åƒå¤„ç†åŒæ­¥é€»è¾‘ä¸€æ ·ç®¡ç†erroräº‹ä»¶ã€‚

åœ¨ES7ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³è¿è¿™ä¸€å±‚å°è£…éƒ½ä¸éœ€è¦å†™äº†ï¼Œå˜å¾—æ›´æ–¹ä¾¿

## å‚è€ƒ
-	[Asynchronous calls with ES6 generators](http://blog.mgechev.com/2014/12/21/handling-asynchronous-calls-with-es6-javascript-generators/)
- 	[\[Javascript\] Promise, generator, asyncèˆ‡ES6](http://huli.logdown.com/posts/292655-javascript-promise-generator-async-es6)
-  [The Hidden Power of ES6 Generators: Observable Async Flow Control](https://medium.com/javascript-scene/the-hidden-power-of-es6-generators-observable-async-flow-control-cfa4c7f31435#.4cadgop5s)
- [Going Async With ES6 Generators](https://davidwalsh.name/async-generators)